(()=>{var ee=Object.defineProperty;var r=(e,n)=>ee(e,"name",{value:n,configurable:!0});var u="anonymous";function O(...e){return e=e.filter(n=>typeof n=="string"),`modules/${u}/templates/${e.join("/")}`}r(O,"templatePath");function U(){let e=game.data,n=e.users.find(t=>t._id===e.userId);return!!n&&n.role>=CONST.USER_ROLES.GAMEMASTER}r(U,"isGM");function I(e,n,t){return e.getFlag(u,n)??t}r(I,"getFlag");function P(e,n,t){return e.setFlag(u,n,t)}r(P,"setFlag");function g(...e){let[n,t]=e;return n=`${u}.${n}`,t?game.i18n.format(n,t):game.i18n.localize(n)}r(g,"localize");function D(e){let n=r((...t)=>g(`${e}.${t[0]}`,t[1]),"fn");return Object.defineProperties(n,{warn:{value:(...t)=>T(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},info:{value:(...t)=>te(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},error:{value:(...t)=>ne(`${e}.${t[0]}`,t[1],t[2]),enumerable:!1,configurable:!1},has:{value:t=>hasLocalization(`${e}.${t}`),enumerable:!1,configurable:!1},path:{value:t=>localizePath(`${e}.${t}`),enumerable:!1,configurable:!1},template:{value:(t,{hash:o})=>n(t,o),enumerable:!1,configurable:!1}}),n}r(D,"subLocalize");function G(e){return e.combat.turns.filter(n=>n.actorId===e.actorId)}r(G,"getSameCombatants");function m(e){return game.settings.get(u,e)}r(m,"getSetting");function R(e,n){return game.settings.set(u,e,n)}r(R,"setSetting");function F(e){return e?e[0].toUpperCase()+e.slice(1):""}r(F,"capitalize");function h(e){let n=e.name;e.scope=e.scope??"world",e.config=e.config??!1,e.config&&(e.name=p(n,"name"),e.hint=p(n,"hint")),Array.isArray(e.choices)&&(e.choices=e.choices.reduce((t,o)=>(t[o]=p(n,"choices",o),t),{})),game.settings.register(u,n,e)}r(h,"registerSetting");function j(e){let n=e.name;e.name=p("menus",n,"name"),e.label=p("menus",n,"label"),e.hint=p("menus",n,"hint"),e.restricted=e.restricted??!0,e.icon=e.icon??"fas fa-cogs",game.settings.registerMenu(u,n,e)}r(j,"registerSettingMenu");function p(...e){return`${u}.settings.${e.join(".")}`}r(p,"getSettingLocalizationPath");function C(){return game.modules.get(u)}r(C,"getCurrentModule");function M(e,n,t,o){let a=typeof n=="string"?n:"info",c=typeof n=="object"?n:typeof t=="object"?t:void 0,s=typeof n=="boolean"?n:typeof t=="boolean"?t:o??!1;ui.notifications.notify(g(e,c),a,{permanent:s})}r(M,"notify");function T(...e){let[n,t,o]=e;M(n,"warning",t,o)}r(T,"warn");function te(...e){let[n,t,o]=e;M(n,"info",t,o)}r(te,"info");function ne(...e){let[n,t,o]=e;M(n,"error",t,o)}r(ne,"error");function k(e,n,t,o=!1){let a=e.find("*");o&&(a=a.addBack()),a.contents().each((c,s)=>{s.nodeType===Node.TEXT_NODE&&s.textContent?.trim()&&$(s).replaceWith(s.textContent.replace(n,t))})}r(k,"replaceHTMLText");function f(e){return e instanceof Combatant&&e.actor&&(e=e.actor),e instanceof Actor&&e.hasPlayerOwner?!0:!!I(e,"showName")}r(f,"playersSeeName");async function y(e){let n=!f(e);e instanceof Actor||!e.actor?await P(e,"showName",n):await P(e.actor,"showName",n),canvas.tokens.hud?.rendered&&canvas.tokens.hud.render();let t=e instanceof Actor?e:e.actor;return n}r(y,"toggleSeeName");function d(e){let n=g("unknown"),t=e instanceof Actor?e.type:e.actor?.type;return t?(E()[t]??"").trim()||H(n,t):n}r(d,"getName");function N(){ui.combat.render()}r(N,"refresh");function E(){return m("names")}r(E,"getSavedNames");function H(e,n){return`${e} ${F(n)}`}r(H,"formatUnknown");function _(e,n){re({entries:n,defaultData:{name:t=>g(`context.${t}`),icon:"fa-solid fa-signature",callback:t=>{let o=t.attr("data-document-id"),a=game.actors.get(o);a&&y(a)},condition:(t,o)=>{let a=t.attr("data-document-id"),c=game.actors.get(a);return!!c&&!c.hasPlayerOwner&&(o==="show"?!f(c):f(c))}},choices:["show","hide"]})}r(_,"getActorDirectoryEntryContext");function B(e,n){let t=getProperty(n,`flags.${u}.showName}`)!==void 0;"ownership"in n&&(t=!0),t&&N()}r(B,"onActorUpdate");function re({entries:e,choices:n,defaultData:t={}}){Array.isArray(n)&&(n=n.reduce((o,a)=>(o[a]={},o),{}));for(let o in n){let a=n[o],c=a.name??(typeof t.name=="function"?t.name(o):t.name)??"",s=a.icon??(typeof t.icon=="function"?t.icon(o):t.icon)??"";if(!$(s).length){let i=$("<i></i>");i.addClass(s),s=i[0].outerHTML}e.unshift({name:c,icon:s,callback:i=>{a.callback?a.callback(i):t.callback&&t.callback(i,o)},condition:i=>a.condition?.(i)??t.condition?.(i,o)??!0})}}r(re,"addSelectContextEntry");var b=class extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"anonymous-names-menu",title:g("templates.names.title"),template:O("names.html"),width:400})}getData(n){let t=g("unknown"),o=E(),a=game.system.documentTypes.Actor.map(c=>({type:c,value:(o[c]??"").trim(),placeholder:H(t,c)}));return{...super.getData(n),types:a,i18n:D("templates.names")}}activateListeners(n){super.activateListeners(n),n.find("[data-action=cancel]").on("click",()=>this.close())}async _updateObject(n,t){R("names",t)}};r(b,"AnonymousNamesMenu");function V({message:e,$html:n,isAnonymous:t,actor:o}){if(t&&e.rolls.length&&m("criticals")){let a=game.i18n.localize("DND5E.CriticalHit"),c=game.i18n.localize("DND5E.PowerfulCritical"),s=new RegExp(` (\\(([\\w ]*)?(?:${a}|${c})([\\w ]*)?\\))$`,"igm"),i=n.find("header .flavor-text");game.user.isGM&&k(i,s,' <span class="anonymous-replaced">$1</span>',!0),k(i,s,"",!0)}}r(V,"dnd5ParseChat");function q(e){h({name:"pf2e.traits",type:String,default:"never",config:!0,choices:{never:p("pf2e.traits.choices.never"),rolls:p("pf2e.traits.choices.rolls"),always:p("pf2e.traits.choices.always")}})}r(q,"pf2eInitHook");function W(e){e&&oe()}r(W,"pf2eReadyHook");function oe(){let e="";if(game.settings.settings.has("pf2e.metagame.tokenSetsNameVisibility")?e="metagame.tokenSetsNameVisibility":game.settings.settings.has("pf2e.metagame_tokenSetsNameVisibility")&&(e="metagame_tokenSetsNameVisibility"),!e||!game.settings.get("pf2e",e))return;let n=C().title,t=game.i18n.localize("PF2E.SETTINGS.Metagame.TokenSetsNameVisibility.Name");game.settings.set("pf2e",e,!1),T("pf2e.disabled",{module:n,setting:t},!0)}r(oe,"disableSettings");function X({message:e,isAnonymous:n,$html:t}){let o=game.user.isGM,a=e.target?.actor,c=m("criticals"),s=m("rolls");if(a&&!a.hasPlayerOwner&&!f(a)){let i=t.find('.flavor-text .target-dc [data-whose="target"]');if(i.length){let l=i.first();o?l.attr("data-visibility","gm"):l.text(g("pf2e.target",{name:d(a)}))}}if(!o&&n){let i=m("pf2e.traits");if(e.rolls.length)if(s){let l=t.find(".flavor-text hr + .tags");l.length&&(l.prev("hr").remove(),l.remove()),c&&t.find(".message-content .dice-roll .dice-result .dice-total").css("color","var(--color-text-dark-primary)"),i!=="never"&&t.find(".flavor-text .tags").remove()}else i==="always"&&t.find(".flavor-text .tags").first().remove();else i==="always"&&t.find(".message-content section.tags").remove()}if(n&&e.rolls.length&&s&&c){let i=game.i18n.localize("PF2E.Check.Result.Degree.Attack.criticalSuccess"),l=game.i18n.localize("PF2E.Check.Result.Degree.Attack.success"),x=new RegExp(`(\\((${i}|${l})\\))`,"gmi"),v=o?'<span class="anonymous-replaced">$1</span>':"",w=t.find("header .flavor-text");k(w,x,v,!0)}}r(X,"pf2eParseChat");var ae=/\(dc \d+\)/gim;function J({message:e,isAnonymous:n,$html:t}){if(game.user.isGM)return;if(n&&m("rolls")){let i=t.find(".dice-tooltip");i.empty(),i.css("padding-top",0),m("criticals")&&t.find(".dice-total").removeClass("critical fumble");let l=t.find(".phase-saving-throws .phase-heading");l.text(l.text().replace(ae,""))}let o=t.find(".phase-attack .token-info .token-name"),a=e.getFlag("wire","activation.attack.targetActorUuid");if(o.length&&a)try{let i=fromUuidSync(a)?.actor;i&&!i.hasPlayerOwner&&!f(i)&&o.text(d(i))}catch(i){console.error(i)}let c=t.find(".phase-saving-throws .saving-throw-target:has(.target-name)"),s=e.getFlag("wire","activation.targetUuids");if(c.length&&s?.length)try{for(let i of s){let l=fromUuidSync(i)?.actor;l&&!l.hasPlayerOwner&&!f(l)&&c.filter(`[data-actor-id="${i}"]`).find(".target-name").text(d(l))}}catch(i){console.error(i)}}r(J,"wireParseChat");var A=L(),z=L(),S=L();function Q(){switch(game.system.id){case"pf2e":A.add(q),z.add(W),S.add(X);break;case"dnd5e":S.add(V);break}game.modules.get("wire")?.active&&S.add(J)}r(Q,"thirdPartyInitialization");function L(){let e=[],n=r(function(...t){e.forEach(o=>o(...t))},"f");return n.add=t=>e.push(t),n}r(L,"createThirdPartyListener");function Y(e,n){if(e.blind)return;let t=game.user.isGM,o=e.speaker,a=ChatMessage.getSpeakerActor(o),c=!a||f(a),s=!!a&&!a.hasPlayerOwner;if(a&&!c&&ie(e,a,n),!t&&s){if(e.rolls.length&&m("rolls")){let i=n.find(".message-content .dice-roll .dice-result");i.find(".dice-formula, .dice-tooltip").remove(),m("criticals")&&i.find(".dice-total").removeClass("critical fumble")}m("footer")&&n.find(".message-content footer.card-footer").remove(),m("cardContent")&&n.find(".message-content .card-content").remove()}S({message:e,actor:a,$html:n,playersCanSee:c,isAnonymous:s})}r(Y,"renderChatMessage");function ie(e,n,t){let o=e.speaker,a=new Set;if(o.alias&&a.add(o.alias),n.name&&a.add(n.name),o.token&&o.scene){let w=game.scenes.get(o.scene)?.tokens.get(o.token);w?.name&&a.add(w.name)}if(!a.size)return;let s=Array.from(a).map(v=>RegExp.escape(v)).join("|"),i=new RegExp(`\\b(${s})\\b`,"gmi"),l=d(n),x=game.user.isGM?`<span class="anonymous-replaced" title="${l}">$1</span>`:l;k(t,i,x)}r(ie,"changeNames");function Z(e,n){let t=e.object.actor;if(!t||t.hasPlayerOwner)return;let o=se(t);o.addEventListener("click",()=>y(t)),n.find(".col.right").append(o)}r(Z,"renderTokenHUD");function se(e){let n=document.createElement("template"),t=f(e);return n.innerHTML=`<div class="control-icon${t?" active":""}" data-action="anonymous-toggle">
    <i class="fa-solid fa-signature" title="${g("hud.title")}"></i>
</div>`,n.content.firstChild}r(se,"createToggle");function K(e,n){let t=ui.combat.viewed?.combatants;!t||!t.size||n.find("#combat-tracker .combatant").each(function(){let o=this.dataset.combatantId,a=t.get(o);if(!a||!a.actor||a.actor.hasPlayerOwner)return;let c=f(a);if(game.user.isGM){let s=this.querySelector(".combatant-controls"),i=s.querySelector('.combatant-control[data-control="toggleHidden"]'),l=le(c);l.addEventListener("click",x=>ce(x,a)),i?i.after(l):s.appendChild(l)}else if(!c){let s=this.querySelector("h4");s.textContent=d(a)}})}r(K,"renderCombatTracker");function ce(e,n){e.preventDefault(),e.stopPropagation(),e.shiftKey&&n.actor&&n.actor.isToken&&game.combat?.scene?G(n).forEach(y):y(n)}r(ce,"toggleCombatantName");function le(e){let n=document.createElement("template"),t=e?"context.hide":"context.show";return n.innerHTML=`<a
    class="combatant-control${e?" active":""}"
    data-control="toggle-name-visibility"
    data-tooltip="${g(t)}"
>
    <i class="fa-solid fa-signature"></i>
</a>`,n.content.firstChild}r(le,"createToggle");Hooks.once("init",()=>{h({name:"version",type:String,default:""}),h({name:"names",type:Object,default:{},onChange:N}),h({name:"token",type:Boolean,default:!0,config:!0}),h({name:"rolls",type:Boolean,default:!0,config:!0}),h({name:"criticals",type:Boolean,default:!0,config:!0}),h({name:"cardContent",type:Boolean,default:!1,config:!0}),h({name:"footer",type:Boolean,default:!1,config:!0}),j({name:"namesMenu",type:b}),C().api={playersSeeName:f,toggleSeeName:y,getName:d};let e=U();e&&(Hooks.on("getActorDirectoryEntryContext",_),Hooks.on("renderTokenHUD",Z)),Q(),A(e)});Hooks.once("ready",()=>{z(game.user.isGM)});Hooks.on("renderCombatTracker",K);Hooks.on("renderChatMessage",Y);Hooks.on("updateActor",B);})();
//# sourceMappingURL=main.js.map
